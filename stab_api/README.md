
# **API Documentation - Photogrammetry Assistant**

## **Base URL**
```
/api
```
---

## **1. Получить список задач** (READ)

### **Endpoint**:
```
GET /tasks
```

### **Описание**:
Возвращает список доступных задач для выбора.

### **Параметры запроса**:
- **category** (опционально): Фильтрация задач по категории.
- **difficulty** (опционально): Фильтрация задач по сложности.
- **sort_by** (опционально): Параметр сортировки.
- **order** (опционально): Направление сортировки (`asc`, `desc`).

### **Ответ**:
```json
{
    "tasks": [
        {
            "id": 1,
            "name": "3D моделирование",
            "description": "Создание 3D модели из фотографий",
            "icon": "3d_icon.png",
            "category": "3D моделирование",
            "difficulty": "medium",
            "priority": 3,
            "estimated_time": "3h",
            "tags": ["моделирование", "фотограмметрия"],
            "created_at": "2024-11-01T12:00:00Z",
            "updated_at": "2024-11-02T15:30:00Z"
        },
        {
            "id": 2,
            "name": "Измерение расстояний",
            "description": "Определение расстояний между объектами",
            "icon": "distance_icon.png",
            "category": "Геодезия",
            "difficulty": "easy",
            "priority": 2,
            "estimated_time": "1h",
            "tags": ["анализ", "геодезия"],
            "created_at": "2024-10-25T09:00:00Z",
            "updated_at": "2024-10-26T10:15:00Z"
        }
    ]
}
```

---

## **2. Создать задачу** (CREATE)

### **Endpoint**:
```
POST /tasks
```

### **Описание**:
Создаёт новую задачу. Возвращает информацию о созданной задаче.

### **Параметры запроса (JSON)**:
```json
{
    "name": "Фотографическая реконструкция",
    "description": "Метод, при котором множество фотографий комбинируются для создания 3D-объектов.",
    "icon": "reconstruction_icon.png",
    "category": "3D моделирование",
    "difficulty": "hard",
    "priority": 4,
    "estimated_time": "4h",
    "tags": ["реконструкция", "3D", "фотограмметрия"]
}
```

### **Ответ**:
```json
{
    "message": "Задача успешно создана",
    "task": {
        "id": 4,
        "name": "Фотографическая реконструкция",
        "description": "Метод, при котором множество фотографий комбинируются для создания 3D-объектов.",
        "icon": "reconstruction_icon.png",
        "category": "3D моделирование",
        "difficulty": "hard",
        "priority": 4,
        "estimated_time": "4h",
        "tags": ["реконструкция", "3D", "фотограмметрия"],
        "created_at": "2024-11-07T14:00:00Z",
        "updated_at": "2024-11-07T14:00:00Z"
    }
}
```

### **Ошибки**:
- **400 Bad Request**: Если обязательные поля не предоставлены или имеют неверный формат.
- **422 Unprocessable Entity**: Если переданы некорректные данные для создания задачи (например, несуществующий тип сложности).

---

## **3. Обновить задачу** (UPDATE)

### **Endpoint**:
```
PUT /tasks/{id}
```

### **Описание**:
Обновляет информацию о задаче по ID. 

### **Параметры запроса (JSON)**:
```json
{
    "name": "Фотографическая реконструкция 2.0",
    "description": "Усовершенствованный метод для создания 3D-объектов из множества фотографий.",
    "icon": "reconstruction_v2_icon.png",
    "category": "3D моделирование",
    "difficulty": "medium",
    "priority": 5,
    "estimated_time": "5h",
    "tags": ["реконструкция", "новая версия"]
}
```

### **Ответ**:
```json
{
    "message": "Задача успешно обновлена",
    "task": {
        "id": 4,
        "name": "Фотографическая реконструкция 2.0",
        "description": "Усовершенствованный метод для создания 3D-объектов из множества фотографий.",
        "icon": "reconstruction_v2_icon.png",
        "category": "3D моделирование",
        "difficulty": "medium",
        "priority": 5,
        "estimated_time": "5h",
        "tags": ["реконструкция", "новая версия"],
        "created_at": "2024-11-07T14:00:00Z",
        "updated_at": "2024-11-07T15:30:00Z"
    }
}
```

### **Ошибки**:
- **400 Bad Request**: Если переданы некорректные данные для обновления.
- **404 Not Found**: Если задача с указанным `id` не найдена.

---

## **4. Удалить задачу** (DELETE)

### **Endpoint**:
```
DELETE /tasks/{id}
```

### **Описание**:
Удаляет задачу по ID.

### **Ответ**:
```json
{
    "message": "Задача успешно удалена"
}
```

### **Ошибки**:
- **404 Not Found**: Если задача с указанным `id` не найдена.
- **500 Internal Server Error**: Если произошла ошибка на сервере при удалении.

---

## **Пример работы с CRUD**

### **Пример создания задачи**:
```bash
POST /tasks
{
    "name": "Создание ортофотоплана",
    "description": "Создание точного ортофотоплана с использованием спутниковых снимков",
    "icon": "ortho_plan_icon.png",
    "category": "Геодезия",
    "difficulty": "medium",
    "priority": 4,
    "estimated_time": "6h",
    "tags": ["ортофотоплан", "геодезия", "спутники"]
}
```

### **Пример получения задач**:
```bash
GET /tasks?category=Геодезия&difficulty=medium
```

### **Пример обновления задачи**:
```bash
PUT /tasks/4
{
    "name": "Создание ортофотопланов с корректировками",
    "description": "Создание ортофотопланов с учетом геопривязки",
    "icon": "ortho_plan_v2_icon.png",
    "category": "Геодезия",
    "difficulty": "hard",
    "priority": 5,
    "estimated_time": "7h",
    "tags": ["ортофотоплан", "корректировка"]
}
```

### **Пример удаления задачи**:
```bash
DELETE /tasks/4
```

---

### **Ошибки API**

- **400 Bad Request**: Некорректный запрос (например, отсутствуют обязательные поля, неверный формат данных).
- **404 Not Found**: Запрашиваемая задача не найдена (для GET, PUT, DELETE).
- **422 Unprocessable Entity**: Если переданы данные, которые не могут быть обработаны (например, неверный формат или значение).
- **500 Internal Server Error**: Ошибка сервера при обработке запроса (например, ошибка базы данных).

---
Конечно, давайте доработаем и уточним эндпоинт для загрузки данных. Я добавлю дополнительные поля и уточню параметры запроса, чтобы он был более гибким и детализированным, а также внесу корректировки в описание ошибок и ответов.

---

## **2. Загрузить данные для обработки**

### **Endpoint**:
```
POST /upload
```

### **Описание**:
Этот эндпоинт используется для загрузки данных, таких как фотографии, параметры камеры, GPS-данные и другие метаданные, которые необходимы для выполнения фотограмметрической задачи. Каждая задача может требовать разных параметров в зависимости от типа обработки.

### **Параметры запроса (JSON)**:
```json
{
    "task_id": 1,                          // Идентификатор задачи (обязательное поле)
    "image_files": [                        // Список изображений для загрузки Base64
        "...",
        "...",
        "..."
    ],
    "text": "Фотографии были сделаны на камеру ... с исходным разрешенем ... . Нужно выделить все контуры..."
}
```

### **Описание полей**:
- **task_id**: Идентификатор задачи, для которой загружаются данные. Обязательное поле.
- **image_files**: Список имен файлов изображений, которые должны быть загружены для обработки в виде строки или байт base64.
- **text**: Словестное описание исходных данных и задачи в свободной текстовой форме.

### **Ответ**:
```json
{
    "message": "Данные успешно загружены",
    "task_id": 1,
    "status": "processing",                // Статус обработки данных (например, "processing" или "queued")
    "uploaded_images": [                   // Список загруженных изображений
        {
            "filename": "...",
            "status": "uploaded",
            "size": "2MB"
        },
        {
            "filename": "...",
            "status": "uploaded",
            "size": "2.5MB"
        }
    ]
}
```

### **Описание ответа**:
- **message**: Сообщение об успешной загрузке данных.
- **task_id**: Идентификатор задачи, для которой были загружены данные.
- **status**: Текущий статус обработки данных. Это может быть значение "processing" (в обработке), "queued" (в очереди) или "completed" (завершено).
- **uploaded_images**: Список загруженных изображений с дополнительной информацией о каждом изображении:
  - **filename**: Имя файла изображения.
  - **status**: Статус загрузки изображения (например, "uploaded").
  - **size**: Размер изображения в мегабайтах.

---

### **Ошибки**:

- **400 Bad Request**: Возвращается, если обязательные поля не предоставлены или если данные имеют неверный формат.
    - Пример: Если не указаны обязательные параметры `task_id` или `text`, или если список изображений пуст.
  
    **Ответ**:
    ```json
    {
        "error": "400 Bad Request",
        "message": "Необходимо указать параметры task_id, text и хотя бы одно изображение для загрузки."
    }
    ```

- **500 Internal Server Error**: Возвращается, если произошла ошибка на сервере (например, ошибка в процессе обработки или сохранения данных).
  
    **Ответ**:
    ```json
    {
        "error": "500 Internal Server Error",
        "message": "Произошла ошибка при загрузке данных. Попробуйте снова."
    }
    ```

- **415 Unsupported Media Type**: Возвращается, если загруженные изображения имеют неподдерживаемый формат (например, не конвертируется строка из base64 в изображения).

    **Ответ**:
    ```json
    {
        "error": "415 Unsupported Media Type",
        "message": "Неподдерживаемый формат изображения. Пожалуйста, загрузите изображения в формате .jpg, .png, .jpeg."
    }
    ```

---

### **Пример запроса**:

**Запрос**:
```bash
POST /upload
{
    "task_id": 1,
    "image_files": [
        "afeqwfqwfqwwfqwfqwcdasfwgwwgqg",
        "asfqg13gf2effr32f42g4gef21d2",
        "311g313f1d3f13dqfwfwqfqwdfqwfq"
    ],
    "text": ""
}
```

**Ответ**:
```json
{
    "message": "Данные успешно загружены",
    "task_id": 1,
    "status": "processing",
    "uploaded_images": [
        {
            "filename": "...",
            "status": "uploaded",
            "size": "2MB"
        },
        {
            "filename": "...",
            "status": "uploaded",
            "size": "2.5MB"
        },
        {
            "filename": "...",
            "status": "uploaded",
            "size": "2.2MB"
        }
    ]
}
```

---
## **3. Получить пайплайн обработки для задачи**

### **Endpoint**:
```
GET /pipeline
```

### **Описание**:
Возвращает структуру пайплайна, представляющую собой цепочку методов фотограмметрической обработки данных.

### **Ответ**:
```json
{
    "nodes": [
        {
            "id": "method_1",
            "name": "Стереофотограмметрия",
            "description": "Метод, основанный на использовании пары изображений для получения трехмерной модели объекта."
        },
        {
            "id": "method_2",
            "name": "Лазерное сканирование",
            "description": "Технология, использующая лазерные лучи для создания точной модели объектов и окружающей среды."
        },
        {
            "id": "method_3",
            "name": "Фотографическая реконструкция",
            "description": "Метод, при котором множество фотографий комбинируются для создания 3D-объектов."
        }
    ],
    "edges": [
        {
            "source": "method_1",
            "target": "method_3",
            "properties": {
                "execution_time": "15s",
                "ram_usage": "512MB",
                "cpu_usage": "40%"
            }
        },
        {
            "source": "method_2",
            "target": "method_3",
            "properties": {
                "execution_time": "20s",
                "ram_usage": "1GB",
                "cpu_usage": "60%"
            }
        },
        {
            "source": "method_1",
            "target": "method_2",
            "properties": {
                "execution_time": "25s",
                "ram_usage": "2GB",
                "cpu_usage": "70%"
            }
        }
    ]
}
```

---

## **4. Получить статус выполнения пайплайна**

### **Endpoint**:
```
GET /pipeline/status
```

### **Описание**:
Возвращает текущий статус выполнения пайплайна, включая информацию о текущем шаге, процент выполнения и логи.

### **Ответ**:
```json
{
    "current_step": "Стереофотограмметрия",
    "progress_percentage": 45,
    "logs": [
        "Инициализация...",
        "Обработка данных..."
    ]
}
```

---

## **5. Запуск пайплайна**

### **Endpoint**:
```
POST /pipeline/start
```

### **Описание**:
Запускает пайплайн обработки данных. После запуска выполняются все шаги пайплайна, указанные в методах.

### **Ответ**:
```json
{
    "message": "Пайплайн запущен",
    "status": "running"
}
```

### **Ошибки**:
- **500 Internal Server Error**: Возвращается, если произошла ошибка при запуске пайплайна.

---

## **6. Получить результаты обработки**

### **Endpoint**:
```
GET /results
```

### **Описание**:
Возвращает результаты обработки данных, такие как 3D модель или облако точек.

### **Ответ**:
```json
{
    "task_id": 1,
    "output": [
        {
            "name": "3D модель",
            "type": "model",
            "url": "/static/models/3d_model.obj"
        },
        {
            "name": "Облако точек",
            "type": "point_cloud",
            "url": "/static/point_cloud/point_cloud.ply"
        }
    ]
}
```

---

## **7. Получить изображения для загрузки**

### **Endpoint**:
```
GET /images
```

### **Описание**:
Возвращает список миниатюр изображений для предварительного просмотра, которые могут быть загружены для дальнейшей обработки.

### **Ответ**:
```json
{
    "images": [
        {
            "url": "/static/images/img1_thumb.jpg",
            "name": "Изображение 1"
        },
        {
            "url": "/static/images/img2_thumb.jpg",
            "name": "Изображение 2"
        },
        {
            "url": "/static/images/img3_thumb.jpg",
            "name": "Изображение 3"
        }
    ]
}
```
---

## **8. Получить типы камер**

### **Endpoint**:
```
GET /camera-types
```

### **Описание**:
Возвращает список доступных типов камер и их характеристики, включая фокусные расстояния, разрешение сенсора и поддерживаемые форматы изображений. Этот эндпоинт может быть полезен для выбора камеры при загрузке данных, чтобы убедиться, что камера поддерживает необходимый диапазон фокусных расстояний и другие характеристики.

### **Параметры запроса** (необязательные):
- **camera_name**: (string) Фильтрация по названию камеры (например, `Canon EOS`).
- **min_focal_length**: (integer) Минимальное фокусное расстояние (в мм).
- **max_focal_length**: (integer) Максимальное фокусное расстояние (в мм).

Пример фильтрации:
```
GET /camera-types?camera_name=Canon&min_focal_length=20&max_focal_length=100
```

### **Ответ**:
```json
{
    "camera_types": [
        {
            "id": 1,
            "name": "Canon EOS 5D",
            "sensor_resolution": "22.3 MP",
            "sensor_type": "CMOS",
            "focal_lengths": [24, 50, 85],
            "supported_formats": ["JPEG", "RAW", "TIFF"],
            "description": "Камера серии Canon EOS с хорошей динамической диапазонностью, идеально подходит для портретной и пейзажной съемки."
        },
        {
            "id": 2,
            "name": "Nikon D850",
            "sensor_resolution": "45.7 MP",
            "sensor_type": "CMOS",
            "focal_lengths": [35, 70, 200],
            "supported_formats": ["JPEG", "RAW", "TIFF"],
            "description": "Высококачественная камера для профессиональных фотографов с высоким разрешением и отличной цветопередачей."
        },
        {
            "id": 3,
            "name": "Sony Alpha 7R",
            "sensor_resolution": "42.4 MP",
            "sensor_type": "Exmor R CMOS",
            "focal_lengths": [28, 50, 100],
            "supported_formats": ["JPEG", "RAW", "HEIF"],
            "description": "Бесперебойная производительность для съемки в условиях низкого освещения и отличное качество изображения для создания 3D моделей."
        }
    ]
}
```

### **Описание полей**:
- **id**: Уникальный идентификатор камеры.
- **name**: Название камеры.
- **sensor_resolution**: Разрешение сенсора камеры (в мегапикселях).
- **sensor_type**: Тип сенсора (например, CMOS, Exmor R CMOS).
- **focal_lengths**: Массив поддерживаемых фокусных расстояний (в мм).
- **supported_formats**: Список форматов изображений, поддерживаемых данной камерой (например, JPEG, RAW, TIFF).
- **description**: Описание камеры с кратким обзором ее характеристик и применения.

### **Ошибки**:
- **400 Bad Request**: Если параметры запроса заданы неверно (например, `min_focal_length` больше, чем `max_focal_length`).
  
  **Ответ**:
  ```json
  {
      "error": "400 Bad Request",
      "message": "Параметры фильтрации заданы некорректно. Убедитесь, что min_focal_length меньше, чем max_focal_length."
  }
  ```

- **404 Not Found**: Если не найдены камеры, соответствующие фильтрам.

  **Ответ**:
  ```json
  {
      "error": "404 Not Found",
      "message": "Камеры, соответствующие заданным параметрам фильтрации, не найдены."
  }
  ```

### **Пример запроса**:
**Запрос**:
```bash
GET /camera-types?camera_name=Canon&min_focal_length=20&max_focal_length=100
```

**Ответ**:
```json
{
    "camera_types": [
        {
            "id": 1,
            "name": "Canon EOS 5D",
            "sensor_resolution": "22.3 MP",
            "sensor_type": "CMOS",
            "focal_lengths": [24, 50, 85],
            "supported_formats": ["JPEG", "RAW", "TIFF"],
            "description": "Камера серии Canon EOS с хорошей динамической диапазонностью, идеально подходит для портретной и пейзажной съемки."
        }
    ]
}
```

---

### Объяснение изменений:
1. **Фильтрация**: Мы добавили возможность фильтрации камер по названию и диапазону фокусных расстояний, чтобы пользователь мог быстро найти подходящую камеру для своей задачи.
   
2. **Новые поля**:
   - **sensor_resolution**: Добавили разрешение сенсора камеры, чтобы пользователи могли выбрать камеры с нужным уровнем детализации.
   - **sensor_type**: Указание типа сенсора, что важно для качества изображения и работы в различных условиях съемки.
   - **supported_formats**: Указание поддерживаемых форматов изображений для правильной работы с файлами.
   - **description**: Описание камеры помогает пользователю понять, какую задачу она может решить.

3. **Ошибки**: Мы добавили дополнительные сообщения об ошибках для некорректных фильтров и пустых результатов поиска, чтобы пользователь знал, что произошло.

---

## **9. Получить список условий освещения**

### **Endpoint**:
```
GET /lighting-conditions
```

### **Описание**:
Возвращает список доступных условий освещения для съемки.

### **Ответ**:
```json
{
    "lighting_conditions": [
        {"id": 1, "name": "Солнечно"},
        {"id": 2, "name": "Облачно"},
        {"id": 3, "name": "Тень"},
        {"id": 4, "name": "Ночной съемки"}
    ]
}
```

---

## **11. Управление логами выполнения пайплайна**

### **Endpoint**:
```
GET /logs
POST /logs
```

### **Описание**:
- **GET**: Возвращает список логов выполнения пайплайна.
- **POST**: Добавляет новый лог в список.

### **Параметры запроса (POST)**:
```json
{
    "log_entry": "Начало выполнения шага"
}
```

### **Ответ**:
- **GET**:
```json
{
    "logs": [
        "Инициализация...",
        "Обработка данных..."
   

 ]
}
```
- **POST**:
```json
{
    "message": "Лог добавлен",
    "logs": [
        "Инициализация...",
        "Обработка данных...",
        "Начало выполнения шага"
    ]
}
```

---

## **Ошибки API**

- **400 Bad Request**: Неверный запрос, например, отсутствует обязательное поле.
- **500 Internal Server Error**: Ошибка на сервере, например, ошибка при запуске пайплайна.